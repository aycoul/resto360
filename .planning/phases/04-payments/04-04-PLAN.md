---
phase: 04-payments
plan: 04
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/api/apps/payments/providers/cash.py
  - apps/api/apps/payments/providers/__init__.py
  - apps/api/apps/payments/serializers.py
  - apps/api/apps/payments/views.py
  - apps/api/apps/payments/urls.py
  - apps/api/apps/payments/tests/test_cash.py
  - apps/api/apps/payments/tests/test_drawer.py
  - apps/api/config/urls.py
autonomous: true

must_haves:
  truths:
    - "Cash payment can be recorded instantly as SUCCESS"
    - "Cashier must have open drawer session to record cash payment"
    - "Drawer session tracks opening/closing balance"
    - "Variance is calculated when drawer is closed"
  artifacts:
    - path: "apps/api/apps/payments/providers/cash.py"
      provides: "CashProvider implementation"
      contains: "class CashProvider(PaymentProvider)"
    - path: "apps/api/apps/payments/views.py"
      provides: "CashDrawerSession API endpoints"
      contains: "CashDrawerSessionViewSet"
    - path: "apps/api/apps/payments/urls.py"
      provides: "Payment URL routes"
      contains: "router.register"
  key_links:
    - from: "apps/api/apps/payments/views.py"
      to: "apps/api/apps/payments/models.py"
      via: "CashDrawerSession CRUD"
      pattern: "CashDrawerSession\\.objects"
    - from: "apps/api/apps/payments/providers/cash.py"
      to: "apps/api/apps/payments/models.py"
      via: "Payment creation"
      pattern: "Payment\\.objects\\.create"
---

<objective>
Implement cash payment provider and cash drawer session management.

Purpose: Cash is still the most common payment method in West African restaurants. Drawer tracking enables end-of-shift reconciliation and accountability.

Output: Working cash provider that records payments instantly, and drawer session endpoints for opening/closing with variance calculation.
</objective>

<execution_context>
@C:\Users\dell\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dell\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-payments/04-RESEARCH.md
@.planning/phases/04-payments/04-01-SUMMARY.md

# Provider base class
@apps/api/apps/payments/providers/base.py
@apps/api/apps/payments/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Cash provider</name>
  <files>
    apps/api/apps/payments/providers/cash.py
    apps/api/apps/payments/providers/__init__.py
  </files>
  <action>
1. Create providers/cash.py with CashProvider class:

**CashProvider(PaymentProvider):**

Properties:
- provider_code = "cash"

Methods:
- __init__(): No config needed for cash

- initiate_payment(...) -> PaymentResult:
  - Cash payments are instant; no external API
  - Return PaymentResult with:
    - provider_reference = idempotency_key (use as reference)
    - status = ProviderStatus.SUCCESS (instant success)
    - redirect_url = None (no redirect needed)
  - Note: Actual Payment record creation happens in service layer

- check_status(provider_reference) -> PaymentResult:
  - Look up Payment by provider_reference
  - Return current status
  - (Cash payments don't need polling, but implement for interface compliance)

- process_refund(provider_reference, amount=None) -> RefundResult:
  - Cash refunds are manual
  - Return RefundResult(success=True) - just mark as refunded
  - Note: Actual cash return is physical; system just tracks it

- verify_webhook(headers, body) -> bool:
  - Cash has no webhooks
  - Return False (never called)

- parse_webhook(body) -> dict:
  - Cash has no webhooks
  - Return empty dict

2. Update providers/__init__.py:
   - Import CashProvider
   - Add "cash" to get_provider() mapping

**Important:**
- Cash payments succeed immediately (no async)
- Cash provider is simpler than mobile money providers
- Refund just updates status; physical cash handled separately
  </action>
  <verify>
    python -c "from apps.payments.providers.cash import CashProvider; p = CashProvider(); r = p.initiate_payment(1000, 'XOF', 'ORD-001', '+225123456789', 'key-1', '', '', ''); print(f'Status: {r.status}')"
  </verify>
  <done>
    - CashProvider class implements PaymentProvider interface
    - initiate_payment returns SUCCESS immediately
    - get_provider("cash") returns CashProvider instance
  </done>
</task>

<task type="auto">
  <name>Task 2: Create drawer session API and payment serializers</name>
  <files>
    apps/api/apps/payments/serializers.py
    apps/api/apps/payments/views.py
    apps/api/apps/payments/urls.py
    apps/api/config/urls.py
  </files>
  <action>
1. Create serializers.py:

**PaymentMethodSerializer:**
- Fields: id, provider_code, name, is_active, display_order
- Read-only: id

**PaymentSerializer:**
- Fields: id, order, payment_method, amount, status, provider_code, provider_reference, initiated_at, completed_at, refunded_amount
- Read-only: id, status, provider_reference, initiated_at, completed_at, refunded_amount

**CashDrawerSessionSerializer:**
- Fields: id, cashier, opened_at, opening_balance, closed_at, closing_balance, expected_balance, variance, variance_notes, is_open
- Read-only: id, cashier, opened_at, expected_balance, variance, is_open
- cashier: Display name/phone, not full user object

**OpenDrawerSerializer:**
- Fields: opening_balance (required, min_value=0)

**CloseDrawerSerializer:**
- Fields: closing_balance (required, min_value=0), variance_notes (optional)

2. Create views.py:

**PaymentMethodViewSet(TenantContextMixin, ModelViewSet):**
- queryset: PaymentMethod.objects.all()
- serializer_class: PaymentMethodSerializer
- permission_classes: [IsAuthenticated]
- List returns active payment methods for restaurant

**CashDrawerSessionViewSet(TenantContextMixin, ModelViewSet):**
- queryset: CashDrawerSession.objects.all()
- serializer_class: CashDrawerSessionSerializer
- permission_classes: [IsAuthenticated]
- http_method_names = ['get', 'post']  # No PUT/DELETE

- @action(detail=False, methods=['post'])
  def open(self, request):
    - Validate with OpenDrawerSerializer
    - Check no open session exists for this cashier
    - Create new CashDrawerSession with opening_balance
    - Return 201 with session data

- @action(detail=False, methods=['get'])
  def current(self, request):
    - Return current open session for authenticated user
    - 404 if no open session

- @action(detail=True, methods=['post'])
  def close(self, request, pk=None):
    - Get session by pk
    - Validate with CloseDrawerSerializer
    - Check session is open and belongs to user
    - Call session.close(closing_balance, notes)
    - Return 200 with updated session data

3. Create urls.py:
```python
from django.urls import path, include
from rest_framework.routers import DefaultRouter
from . import views

router = DefaultRouter()
router.register(r'methods', views.PaymentMethodViewSet, basename='payment-method')
router.register(r'drawer-sessions', views.CashDrawerSessionViewSet, basename='drawer-session')

urlpatterns = [
    path('', include(router.urls)),
]
```

4. Include in config/urls.py:
```python
path("api/payments/", include("apps.payments.urls")),
```

**Important:**
- Use TenantContextMixin from apps.core for tenant context
- Drawer session belongs to cashier (authenticated user)
- One open session per cashier at a time
  </action>
  <verify>
    python apps/api/manage.py check
    python -c "from apps.payments.views import CashDrawerSessionViewSet; print('Views OK')"
  </verify>
  <done>
    - PaymentMethod and CashDrawerSession serializers created
    - CashDrawerSessionViewSet has open/current/close actions
    - URLs registered at /api/payments/
  </done>
</task>

<task type="auto">
  <name>Task 3: Add cash provider and drawer tests</name>
  <files>
    apps/api/apps/payments/tests/test_cash.py
    apps/api/apps/payments/tests/test_drawer.py
  </files>
  <action>
1. Create tests/test_cash.py:

**test_cash_provider_code:** Assert provider_code == "cash"

**test_initiate_payment_instant_success:**
- Call initiate_payment
- Assert status == ProviderStatus.SUCCESS
- Assert redirect_url is None

**test_check_status_returns_current:**
- Create Payment with SUCCESS status
- Call check_status
- Assert returns SUCCESS

**test_process_refund_succeeds:**
- Call process_refund
- Assert RefundResult.success is True

2. Create tests/test_drawer.py:

**test_open_drawer_session:**
- POST /api/payments/drawer-sessions/open/ with opening_balance=50000
- Assert 201, session created

**test_open_drawer_fails_if_already_open:**
- Create open session for user
- POST /api/payments/drawer-sessions/open/
- Assert 400 (already has open session)

**test_get_current_session:**
- Create open session for user
- GET /api/payments/drawer-sessions/current/
- Assert 200, returns session

**test_get_current_session_404_if_none:**
- No session exists
- GET /api/payments/drawer-sessions/current/
- Assert 404

**test_close_drawer_session:**
- Create open session with opening_balance=50000
- Create cash payment of 10000 during session
- POST /api/payments/drawer-sessions/{id}/close/ with closing_balance=60000
- Assert expected_balance=60000, variance=0

**test_close_drawer_calculates_variance:**
- Create open session with opening_balance=50000
- Create cash payment of 10000
- Close with closing_balance=55000 (short 5000)
- Assert variance=-5000

**test_close_drawer_fails_if_already_closed:**
- Create and close a session
- Try to close again
- Assert 400

**test_close_drawer_fails_for_other_user:**
- Create session for user A
- Try to close as user B
- Assert 403 or 404

**Important:**
- Use authenticated API client
- Create test users with cashier role
- Test tenant isolation
  </action>
  <verify>
    cd apps/api && python -m pytest apps/payments/tests/test_cash.py apps/payments/tests/test_drawer.py -v --tb=short
  </verify>
  <done>
    - Cash provider tests pass (4+ tests)
    - Drawer session API tests pass (8+ tests)
    - Variance calculation works correctly
  </done>
</task>

</tasks>

<verification>
1. Cash provider works: `python -c "from apps.payments.providers import get_provider; print(get_provider('cash').provider_code)"`
2. API endpoints accessible: `curl http://localhost:8000/api/payments/methods/` (with auth)
3. All tests pass: `cd apps/api && python -m pytest apps/payments/tests/test_cash.py apps/payments/tests/test_drawer.py -v`
</verification>

<success_criteria>
- CashProvider records payments with instant SUCCESS
- Drawer session can be opened with opening balance
- Current open session is retrievable for authenticated user
- Drawer session can be closed with variance calculation
- Only one open session per cashier allowed
- 12+ tests pass covering provider and drawer operations
</success_criteria>

<output>
After completion, create `.planning/phases/04-payments/04-04-SUMMARY.md`
</output>
