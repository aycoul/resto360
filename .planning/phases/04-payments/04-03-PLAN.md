---
phase: 04-payments
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - apps/api/apps/payments/providers/orange.py
  - apps/api/apps/payments/providers/mtn.py
  - apps/api/apps/payments/providers/__init__.py
  - apps/api/apps/payments/webhooks/handlers.py
  - apps/api/apps/payments/tasks.py
  - apps/api/apps/payments/tests/test_orange.py
  - apps/api/apps/payments/tests/test_mtn.py
  - apps/api/config/settings/base.py
autonomous: true
user_setup:
  - service: orange_money
    why: "Mobile money payment processing"
    env_vars:
      - name: ORANGE_CLIENT_ID
        source: "Orange Developer Portal -> My Apps -> App Details"
      - name: ORANGE_CLIENT_SECRET
        source: "Orange Developer Portal -> My Apps -> App Details"
      - name: ORANGE_MERCHANT_KEY
        source: "Orange Money Business Dashboard"
  - service: mtn_momo
    why: "Mobile money payment processing"
    env_vars:
      - name: MTN_SUBSCRIPTION_KEY
        source: "MTN MoMo Developer Portal -> Profile -> Subscriptions"
      - name: MTN_USER_ID
        source: "Generated via MTN API user provisioning"
      - name: MTN_API_SECRET
        source: "Generated via MTN API user provisioning"

must_haves:
  truths:
    - "Orange Money payment can be initiated with phone number"
    - "MTN MoMo payment can be initiated with phone number"
    - "Both providers support status polling as fallback"
    - "MTN sandbox uses EUR currency, production uses XOF"
  artifacts:
    - path: "apps/api/apps/payments/providers/orange.py"
      provides: "OrangeProvider implementation"
      contains: "class OrangeProvider(PaymentProvider)"
    - path: "apps/api/apps/payments/providers/mtn.py"
      provides: "MTNProvider implementation"
      contains: "class MTNProvider(PaymentProvider)"
  key_links:
    - from: "apps/api/apps/payments/providers/mtn.py"
      to: "MTN MoMo API"
      via: "requests.post"
      pattern: "momodeveloper\\.mtn\\.com|momoapi\\.mtn\\.com"
    - from: "apps/api/apps/payments/tasks.py"
      to: "apps/api/apps/payments/models.py"
      via: "Polling updates Payment status"
      pattern: "poll_payment_status"
---

<objective>
Implement Orange Money and MTN MoMo payment providers with polling fallback.

Purpose: Orange Money and MTN MoMo are major mobile money providers in West Africa. Both require polling as fallback since webhooks are unreliable (Orange) or unavailable in sandbox (MTN).

Output: Working Orange and MTN providers that initiate payments and poll for status updates.
</objective>

<execution_context>
@C:\Users\dell\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dell\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/04-payments/04-RESEARCH.md
@.planning/phases/04-payments/04-01-SUMMARY.md

# Provider base class and Wave for patterns
@apps/api/apps/payments/providers/base.py
@apps/api/apps/payments/providers/wave.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Orange Money provider</name>
  <files>
    apps/api/apps/payments/providers/orange.py
    apps/api/apps/payments/providers/__init__.py
    apps/api/config/settings/base.py
  </files>
  <action>
1. Add Orange Money settings to settings/base.py:
```python
# Orange Money Configuration
ORANGE_CLIENT_ID = env("ORANGE_CLIENT_ID", default="")
ORANGE_CLIENT_SECRET = env("ORANGE_CLIENT_SECRET", default="")
ORANGE_MERCHANT_KEY = env("ORANGE_MERCHANT_KEY", default="")
ORANGE_API_URL = env("ORANGE_API_URL", default="https://api.orange.com/orange-money-webpay/dev/v1")
```

2. Create providers/orange.py with OrangeProvider class:

**OrangeProvider(PaymentProvider):**

Properties:
- provider_code = "orange"
- client_id, client_secret, merchant_key (from settings)
- api_url (from settings)
- _token (cached OAuth token)
- _token_expires (expiry timestamp)

Methods:
- __init__(): Load config from Django settings
- _get_token() -> str:
  - Check if cached token is still valid
  - POST to {api_url}/token with client credentials
  - Cache token and expiry
  - Return access_token

- initiate_payment(...) -> PaymentResult:
  - Get OAuth token
  - POST to {api_url}/webpayment
  - Headers: Authorization: Bearer {token}
  - Body:
    - merchant_key
    - currency: "OUV" (Orange XOF code)
    - order_id: order_reference
    - amount: int (not string for Orange)
    - return_url: success_url
    - cancel_url: error_url
    - notif_url: callback_url
    - reference: idempotency_key
  - Return PaymentResult with:
    - provider_reference from response["pay_token"]
    - redirect_url from response["payment_url"]
    - status=PENDING

- check_status(provider_reference) -> PaymentResult:
  - GET to {api_url}/transactionstatus with pay_token parameter
  - Map status: "SUCCESS" -> SUCCESS, "FAILED"/"CANCELLED" -> FAILED, else PENDING
  - Return PaymentResult with mapped status

- process_refund(provider_reference, amount=None) -> RefundResult:
  - Orange Money refunds require manual process
  - Return RefundResult(success=False, error_message="Orange Money refunds require manual processing via dashboard")

- verify_webhook(headers, body) -> bool:
  - Orange webhooks use notification token verification
  - For now, return True (webhook verification is secondary; polling is primary)
  - TODO: Implement proper verification when Orange docs available

- parse_webhook(body) -> dict:
  - Parse JSON and normalize to standard format

3. Update providers/__init__.py:
   - Import OrangeProvider
   - Add "orange" to get_provider() mapping

**Important:**
- Orange uses "OUV" currency code for XOF
- Orange expects integer amount, not string
- OAuth token has expiry; cache and refresh
- Webhooks are unreliable; polling is essential fallback
  </action>
  <verify>
    python -c "from apps.payments.providers.orange import OrangeProvider; p = OrangeProvider(); print(f'Provider: {p.provider_code}')"
  </verify>
  <done>
    - OrangeProvider class implements all PaymentProvider methods
    - OAuth token caching implemented
    - get_provider("orange") returns OrangeProvider instance
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement MTN MoMo provider</name>
  <files>
    apps/api/apps/payments/providers/mtn.py
    apps/api/apps/payments/providers/__init__.py
    apps/api/config/settings/base.py
  </files>
  <action>
1. Add MTN MoMo settings to settings/base.py:
```python
# MTN MoMo Configuration
MTN_SUBSCRIPTION_KEY = env("MTN_SUBSCRIPTION_KEY", default="")
MTN_USER_ID = env("MTN_USER_ID", default="")
MTN_API_SECRET = env("MTN_API_SECRET", default="")
MTN_ENVIRONMENT = env("MTN_ENVIRONMENT", default="sandbox")  # sandbox or production
MTN_CALLBACK_URL = env("MTN_CALLBACK_URL", default="")
```

2. Create providers/mtn.py with MTNProvider class:

**MTNProvider(PaymentProvider):**

Properties:
- provider_code = "mtn"
- subscription_key, user_id, api_secret (from settings)
- environment (sandbox/production)
- callback_url (from settings)
- base_url: sandbox.momodeveloper.mtn.com or momoapi.mtn.com

Methods:
- __init__(): Load config, set base_url based on environment

- _get_token() -> str:
  - Basic auth with user_id:api_secret (base64 encoded)
  - POST to {base_url}/collection/token/
  - Headers: Ocp-Apim-Subscription-Key
  - Return access_token

- initiate_payment(...) -> PaymentResult:
  - Get OAuth token
  - Generate X-Reference-Id (UUID)
  - Currency: "EUR" if sandbox else "XOF"
  - POST to {base_url}/collection/v1_0/requesttopay
  - Headers:
    - Authorization: Bearer {token}
    - X-Reference-Id: {uuid}
    - X-Target-Environment: {environment}
    - Ocp-Apim-Subscription-Key
    - X-Callback-Url (only if production AND callback_url set)
  - Body:
    - amount: str(amount)
    - currency
    - externalId: order_reference
    - payer: {partyIdType: "MSISDN", partyId: customer_phone.lstrip("+")}
    - payerMessage, payeeNote
  - Expect 202 Accepted
  - Return PaymentResult with provider_reference=X-Reference-Id, status=PENDING

- check_status(provider_reference) -> PaymentResult:
  - GET to {base_url}/collection/v1_0/requesttopay/{provider_reference}
  - Headers: same as initiate but no body
  - Map status: "SUCCESSFUL" -> SUCCESS, "FAILED" -> FAILED, else PENDING
  - Return PaymentResult with mapped status and raw_response

- process_refund(provider_reference, amount=None) -> RefundResult:
  - MTN MoMo uses disbursement API for refunds (requires separate product subscription)
  - Return RefundResult(success=False, error_message="MTN MoMo refunds require disbursement API setup")

- verify_webhook(headers, body) -> bool:
  - MTN callback verification is undocumented for sandbox
  - Return True for now; implement when production docs available

- parse_webhook(body) -> dict:
  - Parse JSON and normalize

3. Update providers/__init__.py:
   - Import MTNProvider
   - Add "mtn" to get_provider() mapping

**Important:**
- MTN sandbox does NOT support callbacks; must poll
- Sandbox uses EUR, production uses XOF
- Phone number must NOT have + prefix (use lstrip("+"))
- 202 Accepted means request received, NOT success
  </action>
  <verify>
    python -c "from apps.payments.providers.mtn import MTNProvider; p = MTNProvider(); print(f'Provider: {p.provider_code}')"
  </verify>
  <done>
    - MTNProvider class implements all PaymentProvider methods
    - Environment-aware (sandbox vs production)
    - get_provider("mtn") returns MTNProvider instance
  </done>
</task>

<task type="auto">
  <name>Task 3: Add polling task and tests</name>
  <files>
    apps/api/apps/payments/tasks.py
    apps/api/apps/payments/webhooks/handlers.py
    apps/api/apps/payments/tests/test_orange.py
    apps/api/apps/payments/tests/test_mtn.py
  </files>
  <action>
1. Add polling task to tasks.py:

```python
@shared_task(bind=True, max_retries=30, default_retry_delay=120)
def poll_payment_status(self, payment_id: str):
    """Poll payment provider for status update (fallback for unreliable webhooks)."""
    from .models import Payment, PaymentStatus
    from .providers import get_provider

    payment = Payment.objects.filter(id=payment_id).first()
    if not payment:
        return

    # Only poll PROCESSING payments
    if payment.status != PaymentStatus.PROCESSING:
        return

    provider = get_provider(payment.provider_code)
    result = provider.check_status(payment.provider_reference)

    if result.status == ProviderStatus.SUCCESS:
        payment.mark_success()
        payment.provider_response = result.raw_response or {}
        payment.save()
    elif result.status == ProviderStatus.FAILED:
        payment.mark_failed(result.error_code, result.error_message)
        payment.provider_response = result.raw_response or {}
        payment.save()
    elif result.status == ProviderStatus.EXPIRED:
        payment.mark_expired()
        payment.provider_response = result.raw_response or {}
        payment.save()
    else:
        # Still pending, retry
        raise self.retry()
```

2. Update webhooks/handlers.py to add Orange and MTN handlers:
   - process_orange_webhook(event_data): Similar to Wave
   - process_mtn_webhook(event_data): Similar to Wave

3. Update process_webhook_event task to handle orange and mtn:
```python
if provider_code == "wave":
    process_wave_webhook(event_data)
elif provider_code == "orange":
    process_orange_webhook(event_data)
elif provider_code == "mtn":
    process_mtn_webhook(event_data)
```

4. Create tests/test_orange.py:
   - test_orange_provider_code
   - test_initiate_payment_success (mock requests)
   - test_check_status_success
   - test_token_caching (call twice, verify only one token request)

5. Create tests/test_mtn.py:
   - test_mtn_provider_code
   - test_sandbox_uses_eur_currency
   - test_initiate_payment_returns_202
   - test_check_status_success
   - test_phone_number_stripped (+ prefix removed)

**Important:**
- Polling retries up to 30 times (1 hour total at 2 min intervals)
- Only poll PROCESSING payments (not PENDING, SUCCESS, FAILED)
- ProviderStatus must be imported in tasks.py
  </action>
  <verify>
    cd apps/api && python -m pytest apps/payments/tests/test_orange.py apps/payments/tests/test_mtn.py -v --tb=short
  </verify>
  <done>
    - poll_payment_status task polls and updates payment status
    - Orange webhook handler added
    - MTN webhook handler added
    - Orange provider tests pass (4+ tests)
    - MTN provider tests pass (5+ tests)
  </done>
</task>

</tasks>

<verification>
1. All providers accessible: `python -c "from apps.payments.providers import get_provider; print([get_provider(p).provider_code for p in ['wave', 'orange', 'mtn']])"`
2. Polling task exists: `python -c "from apps.payments.tasks import poll_payment_status; print('OK')"`
3. All tests pass: `cd apps/api && python -m pytest apps/payments/tests/test_orange.py apps/payments/tests/test_mtn.py -v`
</verification>

<success_criteria>
- OrangeProvider initiates payments via Orange Money API
- MTNProvider initiates payments via MTN MoMo API
- Both providers support status polling
- poll_payment_status Celery task polls PROCESSING payments
- MTN correctly uses EUR in sandbox, XOF in production
- 9+ tests pass covering both providers
</success_criteria>

<output>
After completion, create `.planning/phases/04-payments/04-03-SUMMARY.md`
</output>
