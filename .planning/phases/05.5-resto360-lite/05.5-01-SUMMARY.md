---
phase: 05.5-resto360-lite
plan: 01
subsystem: authentication
tags: [registration, jwt, freemium, model-extension]
depends_on:
  requires: [01-01, 01-02]
  provides: [plan_type_field, public_registration_endpoint]
  affects: [05.5-02, 05.5-03, 05.5-04, 05.5-05]
tech-stack:
  added: []
  patterns: [serializer-returns-dict, unique-slug-generation]
key-files:
  created:
    - apps/api/apps/authentication/migrations/0003_restaurant_plan_type_branding.py
    - apps/api/apps/authentication/tests/test_public_registration.py
  modified:
    - apps/api/apps/authentication/models.py
    - apps/api/apps/authentication/serializers.py
    - apps/api/apps/authentication/views.py
    - apps/api/apps/authentication/urls.py
    - apps/api/config/settings/testing.py
    - apps/api/config/urls.py
decisions:
  - id: 05.5-01-01
    choice: "UUID suffix for slug uniqueness"
    reason: "Guarantees unique slugs without DB round-trips"
  - id: 05.5-01-02
    choice: "Serializer returns dict with user and restaurant"
    reason: "View needs both objects for JWT and response"
  - id: 05.5-01-03
    choice: "SKIP_GIS_APPS env var for testing"
    reason: "Allows running non-GIS tests on Windows without GDAL"
metrics:
  duration: 10 minutes
  completed: 2026-02-04
---

# Phase 5.5 Plan 01: Public Registration API Summary

**One-liner:** Public registration endpoint creating free-tier restaurant + owner with JWT tokens for immediate dashboard access.

## What Was Built

### Restaurant Model Extension
Added freemium-related fields to Restaurant model:
- `plan_type` - CharField with choices: free (default), pro, full
- `logo` - ImageField for Pro tier branding
- `primary_color` - CharField for hex color codes
- `show_branding` - BooleanField (default=True, Pro can set to False)

### Public Registration API
Created `/api/auth/register/` endpoint:
- **Input:** email, password, password_confirm, restaurant_name, phone
- **Validations:** password match, email unique, phone unique, min 8 char password
- **Creates:** Restaurant (plan_type='free') + Owner user (role='owner')
- **Returns:** JWT tokens (access + refresh) + restaurant/user info
- **Auto-generates:** Unique slug from restaurant_name with UUID suffix

### Test Coverage
7 pytest tests covering:
- Successful registration with all validations
- Password mismatch error handling
- Duplicate phone rejection
- Duplicate email rejection
- Unique slug generation for same restaurant names
- Missing required fields validation
- Short password validation

## Key Files

| File | Purpose |
|------|---------|
| `apps/api/apps/authentication/models.py` | Restaurant model with plan_type field |
| `apps/api/apps/authentication/serializers.py` | PublicRegistrationSerializer |
| `apps/api/apps/authentication/views.py` | PublicRegistrationView |
| `apps/api/apps/authentication/urls.py` | /register/ endpoint routing |
| `apps/api/apps/authentication/tests/test_public_registration.py` | 7 test cases |

## API Reference

```bash
# Register new restaurant + owner
POST /api/auth/register/
Content-Type: application/json

{
  "email": "owner@restaurant.com",
  "password": "SecurePass123!",
  "password_confirm": "SecurePass123!",
  "restaurant_name": "My Restaurant",
  "phone": "+2250700000001"
}

# Response 201
{
  "restaurant": {"id": "uuid", "slug": "my-restaurant-a1b2c3d4", "name": "My Restaurant"},
  "user": {"id": "uuid", "name": "My Restaurant Owner", "role": "owner"},
  "access": "eyJ...",
  "refresh": "eyJ..."
}
```

## Decisions Made

1. **UUID suffix for slug uniqueness**: `slugify(name)-{uuid[:8]}` guarantees unique slugs without checking DB
2. **Serializer returns dict**: View needs both user and restaurant objects for JWT generation and response
3. **SKIP_GIS_APPS for testing**: Environment variable allows running authentication tests on Windows without GDAL

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] GDAL not available on Windows**
- **Found during:** Task 3 (test execution)
- **Issue:** Tests failed because delivery app requires GDAL for GeoDjango
- **Fix:** Added SKIP_GIS_APPS option to testing.py, made delivery URLs conditional
- **Files modified:** config/settings/testing.py, config/urls.py
- **Commit:** 5e3a279

**2. [Rule 2 - Missing Critical] /api/auth/ route alias**
- **Found during:** Task 2
- **Issue:** Plan specified /api/auth/register/ but only /api/v1/auth/register/ existed
- **Fix:** Added /api/auth/ route alias in urls.py
- **Files modified:** config/urls.py
- **Commit:** 5e3a279

## Commits

| Hash | Type | Description |
|------|------|-------------|
| 34007ca | feat | Restaurant model plan_type field (previous session) |
| aa07590 | feat | Public registration endpoint |
| 5e3a279 | test | 7 test cases for public registration |

## Next Phase Readiness

### Blockers
- None

### Ready For
- 05.5-02: Landing page can now link to /register/ endpoint
- 05.5-03: Menu builder dashboard needs authenticated user
- 05.5-04: QR code generation needs restaurant context

### Dependencies Delivered
- `plan_type` field available for feature gating
- JWT tokens returned for immediate dashboard access
- Restaurant + User created in single atomic transaction
