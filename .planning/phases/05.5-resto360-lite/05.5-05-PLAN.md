---
phase: 05.5-resto360-lite
plan: 05
type: execute
wave: 3
depends_on: ["05.5-01", "05.5-04"]
files_modified:
  - apps/api/apps/analytics/__init__.py
  - apps/api/apps/analytics/models.py
  - apps/api/apps/analytics/services.py
  - apps/api/apps/analytics/views.py
  - apps/api/apps/analytics/serializers.py
  - apps/api/apps/analytics/urls.py
  - apps/api/apps/analytics/tests/test_analytics.py
  - apps/api/apps/analytics/migrations/0001_initial.py
  - apps/api/config/settings/base.py
  - apps/api/config/urls.py
  - apps/web/app/[locale]/menu/[slug]/page.tsx
  - apps/web/app/[locale]/lite/dashboard/page.tsx
  - apps/web/app/[locale]/lite/upgrade/page.tsx
  - apps/web/lib/hooks/useAnalytics.ts
autonomous: true

must_haves:
  truths:
    - "Menu views are tracked when customers visit public menu"
    - "Dashboard shows view counts (today/week/month)"
    - "Owner can see which items are most viewed"
    - "Upgrade page explains Pro tier benefits"
    - "Upgrade flow captures intent (no payment processing yet)"
  artifacts:
    - path: "apps/api/apps/analytics/models.py"
      provides: "MenuView and DailyMenuStats models"
      contains: "MenuView"
    - path: "apps/api/apps/analytics/views.py"
      provides: "Analytics API endpoints"
      exports: ["MenuViewViewSet", "AnalyticsSummaryView"]
    - path: "apps/web/app/[locale]/lite/upgrade/page.tsx"
      provides: "Upgrade page"
      contains: "upgrade"
  key_links:
    - from: "apps/web/app/[locale]/menu/[slug]/page.tsx"
      to: "/api/analytics/track/"
      via: "POST on page load"
      pattern: "fetch.*track"
    - from: "apps/web/app/[locale]/lite/dashboard/page.tsx"
      to: "/api/analytics/summary/"
      via: "fetch"
      pattern: "fetch.*summary"
---

<objective>
Create analytics models and API for tracking menu views, wire dashboard stats, and build upgrade flow page.

Purpose: Enable owners to see menu engagement metrics and provide clear upgrade path from Free to Pro tier.

Output: MenuView and DailyMenuStats models, tracking endpoint called from public menu, analytics summary endpoint for dashboard, and upgrade page with tier comparison.
</objective>

<execution_context>
@C:\Users\dell\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dell\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05.5-resto360-lite/05.5-CONTEXT.md
@.planning/phases/05.5-resto360-lite/05.5-01-SUMMARY.md
@.planning/phases/05.5-resto360-lite/05.5-04-SUMMARY.md

# Existing models for reference
@apps/api/apps/core/models.py
@apps/api/apps/menu/models.py
# Public menu page to add tracking
@apps/web/app/[locale]/menu/[slug]/page.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics models and API</name>
  <files>
    apps/api/apps/analytics/__init__.py
    apps/api/apps/analytics/apps.py
    apps/api/apps/analytics/models.py
    apps/api/apps/analytics/services.py
    apps/api/apps/analytics/serializers.py
    apps/api/apps/analytics/views.py
    apps/api/apps/analytics/urls.py
    apps/api/apps/analytics/migrations/0001_initial.py
    apps/api/config/settings/base.py
    apps/api/config/urls.py
  </files>
  <action>
Create new analytics Django app:

**apps.py:**
```python
from django.apps import AppConfig

class AnalyticsConfig(AppConfig):
    default_auto_field = 'django.db.models.BigAutoField'
    name = 'apps.analytics'
```

**models.py (per CONTEXT.md spec):**
```python
from django.db import models
from apps.core.models import TenantModel
from apps.core.managers import TenantManager

class MenuView(TenantModel):
    """Individual menu view event for tracking."""
    viewed_at = models.DateTimeField(auto_now_add=True)
    session_id = models.CharField(max_length=100)  # Anonymous tracking
    source = models.CharField(max_length=20, choices=[
        ('qr', 'QR Code'),
        ('link', 'Direct Link'),
        ('whatsapp', 'WhatsApp'),
    ], default='link')
    user_agent = models.TextField(blank=True)

    all_objects = models.Manager()
    objects = TenantManager()

    class Meta:
        ordering = ['-viewed_at']
        indexes = [
            models.Index(fields=['restaurant', 'viewed_at']),
            models.Index(fields=['session_id']),
        ]

class DailyMenuStats(TenantModel):
    """Aggregated daily stats for faster queries."""
    date = models.DateField()
    total_views = models.PositiveIntegerField(default=0)
    unique_visitors = models.PositiveIntegerField(default=0)
    qr_scans = models.PositiveIntegerField(default=0)
    top_items = models.JSONField(default=list)  # [{item_id, views}]

    all_objects = models.Manager()
    objects = TenantManager()

    class Meta:
        ordering = ['-date']
        unique_together = ['restaurant', 'date']
        indexes = [
            models.Index(fields=['restaurant', 'date']),
        ]
```

**services.py:**
```python
from django.utils import timezone
from django.db.models import Count
from datetime import timedelta

def track_menu_view(restaurant, session_id, source='link', user_agent=''):
    """Record a menu view event."""
    from .models import MenuView
    return MenuView.objects.create(
        restaurant=restaurant,
        session_id=session_id,
        source=source,
        user_agent=user_agent
    )

def get_analytics_summary(restaurant):
    """Get view counts for dashboard."""
    from .models import MenuView
    from apps.menu.models import MenuItem

    now = timezone.now()
    today = now.date()
    week_ago = today - timedelta(days=7)
    month_ago = today - timedelta(days=30)

    views = MenuView.objects.filter(restaurant=restaurant)

    return {
        'views_today': views.filter(viewed_at__date=today).count(),
        'views_week': views.filter(viewed_at__date__gte=week_ago).count(),
        'views_month': views.filter(viewed_at__date__gte=month_ago).count(),
        'unique_today': views.filter(viewed_at__date=today).values('session_id').distinct().count(),
        'menu_items': MenuItem.objects.filter(restaurant=restaurant).count(),
    }
```

**views.py:**
```python
from rest_framework import status
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework.permissions import AllowAny, IsAuthenticated
from apps.authentication.models import Restaurant
from .services import track_menu_view, get_analytics_summary
from .serializers import TrackViewSerializer, AnalyticsSummarySerializer

class TrackMenuViewAPI(APIView):
    """Public endpoint to track menu views."""
    permission_classes = [AllowAny]

    def post(self, request):
        serializer = TrackViewSerializer(data=request.data)
        serializer.is_valid(raise_exception=True)

        slug = serializer.validated_data['slug']
        try:
            restaurant = Restaurant.objects.get(slug=slug, is_active=True)
        except Restaurant.DoesNotExist:
            return Response({'error': 'Restaurant not found'}, status=404)

        track_menu_view(
            restaurant=restaurant,
            session_id=serializer.validated_data.get('session_id', ''),
            source=serializer.validated_data.get('source', 'link'),
            user_agent=request.META.get('HTTP_USER_AGENT', '')
        )
        return Response({'status': 'tracked'}, status=201)

class AnalyticsSummaryAPI(APIView):
    """Get analytics summary for authenticated user's restaurant."""
    permission_classes = [IsAuthenticated]

    def get(self, request):
        if not request.user.restaurant:
            return Response({'error': 'No restaurant'}, status=400)

        summary = get_analytics_summary(request.user.restaurant)
        return Response(summary)
```

**urls.py:**
```python
from django.urls import path
from .views import TrackMenuViewAPI, AnalyticsSummaryAPI

urlpatterns = [
    path('track/', TrackMenuViewAPI.as_view(), name='track-view'),
    path('summary/', AnalyticsSummaryAPI.as_view(), name='analytics-summary'),
]
```

**Register app and URLs:**
- Add 'apps.analytics' to INSTALLED_APPS in base.py
- Add path('api/analytics/', include('apps.analytics.urls')) to config/urls.py

Run migrations:
```bash
cd apps/api && python manage.py makemigrations analytics && python manage.py migrate
```
  </action>
  <verify>
    cd apps/api && python manage.py check
    cd apps/api && python manage.py showmigrations analytics
  </verify>
  <done>
    Analytics app with MenuView and DailyMenuStats models, track endpoint (public), summary endpoint (authenticated).
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire tracking to public menu and dashboard stats</name>
  <files>
    apps/web/app/[locale]/menu/[slug]/page.tsx
    apps/web/app/[locale]/lite/dashboard/page.tsx
    apps/web/lib/hooks/useAnalytics.ts
  </files>
  <action>
**Update menu/[slug]/page.tsx:**
Add tracking call on page load:

```tsx
useEffect(() => {
  // Track menu view
  const sessionId = localStorage.getItem('menuSessionId') || crypto.randomUUID();
  localStorage.setItem('menuSessionId', sessionId);

  // Determine source from URL params
  const params = new URLSearchParams(window.location.search);
  const source = params.get('source') || 'link';

  fetch('/api/analytics/track/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      slug,
      session_id: sessionId,
      source
    })
  }).catch(() => {}); // Fail silently
}, [slug]);
```

The QR code should include `?source=qr` parameter so we can track QR scans vs direct links.

**Create useAnalytics.ts hook:**
```tsx
import useSWR from 'swr';

export function useAnalyticsSummary() {
  const { data, error, isLoading, mutate } = useSWR(
    '/api/analytics/summary/',
    (url) => fetch(url, {
      headers: { 'Authorization': `Bearer ${getAccessToken()}` }
    }).then(res => res.json())
  );

  return {
    stats: data,
    isLoading,
    error,
    refresh: mutate
  };
}
```

**Update lite/dashboard/page.tsx:**
Replace placeholder stats with real data:

```tsx
import { useAnalyticsSummary } from '@/lib/hooks/useAnalytics';

export default function DashboardPage() {
  const { stats, isLoading } = useAnalyticsSummary();

  // Render stats cards with real data
  // views_today, views_week, views_month, menu_items
}
```

Add loading skeletons for stats while loading.
  </action>
  <verify>
    npm run build --prefix apps/web
  </verify>
  <done>
    Public menu tracks views, dashboard displays real analytics data.
  </done>
</task>

<task type="auto">
  <name>Task 3: Create upgrade page and write tests</name>
  <files>
    apps/web/app/[locale]/lite/upgrade/page.tsx
    apps/api/apps/analytics/tests/__init__.py
    apps/api/apps/analytics/tests/test_analytics.py
    apps/web/messages/fr.json
    apps/web/messages/en.json
  </files>
  <action>
**Create upgrade/page.tsx:**
Upgrade page showing tier comparison:

- Side-by-side comparison: Free vs Pro vs Full Platform
- Feature matrix table
- Pricing: Free ($0), Pro ($10/month), Full (Contact us)
- For now, Pro CTA shows "Coming Soon" or captures email interest
- Full Platform CTA links to contact form or email

```tsx
'use client';

import { useState } from 'react';
import { useTranslations } from 'next-intl';

export default function UpgradePage() {
  const t = useTranslations('lite.upgrade');
  const [selectedPlan, setSelectedPlan] = useState<string | null>(null);
  const [email, setEmail] = useState('');
  const [submitted, setSubmitted] = useState(false);

  const handleInterest = async () => {
    // For now, just log interest or send to simple endpoint
    // Payment processing deferred to future phase
    setSubmitted(true);
  };

  return (
    <div className="max-w-4xl mx-auto py-12 px-4">
      <h1 className="text-3xl font-bold text-center mb-8">{t('page_title')}</h1>

      {/* Tier comparison cards */}
      <div className="grid md:grid-cols-3 gap-6 mb-12">
        {/* Free tier */}
        {/* Pro tier - highlighted */}
        {/* Full Platform tier */}
      </div>

      {/* Feature comparison table */}

      {/* Interest capture form */}
      {!submitted ? (
        <div className="bg-gray-50 rounded-lg p-6 text-center">
          <p className="mb-4">Interested in Pro? We'll notify you when it's available.</p>
          <input
            type="email"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            placeholder="Your email"
            className="..."
          />
          <button onClick={handleInterest}>Notify Me</button>
        </div>
      ) : (
        <div className="text-center text-green-600">
          Thanks! We'll be in touch soon.
        </div>
      )}
    </div>
  );
}
```

**Add translations:**
```json
"upgrade": {
  "page_title": "Choose Your Plan",
  "tiers": {
    "free": {
      "name": "Free",
      "price": "$0",
      "description": "Perfect for getting started",
      "features": ["Unlimited menu items", "QR code generator", "Basic analytics"]
    },
    "pro": {
      "name": "Pro",
      "price": "$10/month",
      "description": "For growing restaurants",
      "features": ["Everything in Free", "Custom branding", "Remove RESTO360 logo", "Priority support"],
      "cta": "Coming Soon"
    },
    "full": {
      "name": "Full Platform",
      "price": "Contact us",
      "description": "Complete restaurant OS",
      "features": ["Everything in Pro", "POS system", "Payment processing", "Delivery management", "Kitchen display"],
      "cta": "Contact Sales"
    }
  },
  "interest": {
    "title": "Interested in upgrading?",
    "placeholder": "Your email",
    "submit": "Notify Me",
    "success": "Thanks! We'll be in touch soon."
  }
}
```

**Create analytics tests:**
```python
import pytest
from django.urls import reverse
from apps.authentication.models import Restaurant, User
from apps.analytics.models import MenuView
from apps.analytics.services import track_menu_view, get_analytics_summary

@pytest.mark.django_db
class TestAnalyticsTracking:
    def test_track_menu_view_public(self, client):
        restaurant = Restaurant.objects.create(
            name='Test', slug='test', phone='123'
        )
        response = client.post(
            '/api/analytics/track/',
            {'slug': 'test', 'session_id': 'abc123', 'source': 'qr'},
            content_type='application/json'
        )
        assert response.status_code == 201
        assert MenuView.objects.filter(restaurant=restaurant).count() == 1

    def test_track_menu_view_nonexistent_restaurant(self, client):
        response = client.post(
            '/api/analytics/track/',
            {'slug': 'nonexistent', 'session_id': 'abc'},
            content_type='application/json'
        )
        assert response.status_code == 404

    def test_analytics_summary_authenticated(self, client, auth_headers):
        # Create some views
        # Fetch summary
        # Assert counts are correct
        pass

    def test_analytics_summary_unauthenticated(self, client):
        response = client.get('/api/analytics/summary/')
        assert response.status_code == 401
```
  </action>
  <verify>
    cd apps/api && python -m pytest apps/analytics/tests/ -v
    npm run build --prefix apps/web
  </verify>
  <done>
    Upgrade page shows tier comparison with interest capture, analytics tests pass.
  </done>
</task>

</tasks>

<verification>
1. Visit /menu/test-restaurant -> MenuView record created
2. Check source=qr parameter tracking works
3. /api/analytics/summary/ returns view counts
4. Dashboard shows real stats (today/week/month)
5. /lite/upgrade page shows tier comparison
6. Interest form captures email (or shows success message)
7. All analytics tests pass
</verification>

<success_criteria>
- MenuView model tracks page views with session deduplication
- Public menu page calls tracking API on load
- Dashboard displays real view counts from API
- Upgrade page clearly compares Free/Pro/Full tiers
- Interest capture works (payment processing deferred)
- Analytics tests cover tracking and summary endpoints
- QR codes include source=qr parameter for accurate tracking
</success_criteria>

<output>
After completion, create `.planning/phases/05.5-resto360-lite/05.5-05-SUMMARY.md`
</output>
