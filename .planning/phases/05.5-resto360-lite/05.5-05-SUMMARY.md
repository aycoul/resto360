---
phase: 05.5-resto360-lite
plan: 05
subsystem: analytics
tags: [django, menu-tracking, analytics, upgrade-flow, rest-api, next.js]

# Dependency graph
requires:
  - phase: 05.5-01
    provides: Restaurant model with plan_type, menu app structure
  - phase: 05.5-04
    provides: Lite dashboard layout with context
provides:
  - MenuView model for tracking individual menu views
  - DailyMenuStats model for aggregated statistics
  - Analytics API (track endpoint public, summary endpoint authenticated)
  - useAnalytics hook for frontend integration
  - Upgrade page with tier comparison
affects: [06-whatsapp-ordering, 09-analytics]

# Tech tracking
tech-stack:
  added: []
  patterns:
    - Public API with AllowAny permission
    - Session-based unique visitor tracking via localStorage
    - Source detection from URL params and referrer

key-files:
  created:
    - apps/api/apps/analytics/models.py
    - apps/api/apps/analytics/services.py
    - apps/api/apps/analytics/views.py
    - apps/api/apps/analytics/urls.py
    - apps/api/apps/analytics/tests/test_analytics.py
    - apps/web/lib/hooks/useAnalytics.ts
    - apps/web/app/[locale]/lite/upgrade/page.tsx
  modified:
    - apps/api/config/settings/base.py
    - apps/api/config/settings/testing.py
    - apps/api/config/urls.py
    - apps/web/app/[locale]/menu/[slug]/page.tsx
    - apps/web/app/[locale]/lite/dashboard/page.tsx
    - apps/web/messages/en.json
    - apps/web/messages/fr.json

key-decisions:
  - "JSONField instead of ArrayField for top_items (SQLite compatibility)"
  - "Session ID stored in localStorage for persistent unique visitor tracking"
  - "Source detection from URL params (?source=qr) and referrer"
  - "Tracking endpoint is public (AllowAny) for anonymous menu visitors"
  - "Upgrade form captures email interest only (no payment processing yet)"

patterns-established:
  - "Public tracking API pattern: AllowAny permission, restaurant lookup by slug"
  - "useAnalyticsSummary hook pattern for authenticated data fetching"
  - "useRef for tracking de-duplication on component mount"

# Metrics
duration: 10min
completed: 2026-02-04
---

# Phase 05.5 Plan 05: Menu Analytics Summary

**Menu view tracking with session-based unique visitors, dashboard stats integration, and upgrade page with tier comparison**

## Performance

- **Duration:** 10 min
- **Started:** 2026-02-04T09:41:02Z
- **Completed:** 2026-02-04T09:50:55Z
- **Tasks:** 3
- **Files modified:** 17

## Accomplishments

- Created analytics Django app with MenuView and DailyMenuStats models
- Implemented track_menu_view and get_analytics_summary services
- Built public tracking API (POST /api/v1/analytics/track/)
- Built authenticated summary API (GET /api/v1/analytics/summary/)
- Integrated tracking into public menu page with session-based de-duplication
- Updated lite dashboard to display real analytics data
- Created upgrade page with Free/Pro/Full tier comparison and feature matrix
- Added email interest capture form for Pro tier (Coming Soon)
- Wrote 14 comprehensive tests (all passing)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create analytics models and API** - `561f489` (feat)
2. **Task 2: Wire tracking to public menu and dashboard stats** - `3ce6f51` (feat)
3. **Task 3: Create upgrade page and write tests** - `5123e13` (feat)

## Files Created/Modified

**Backend (apps/api):**
- `apps/analytics/__init__.py` - App module
- `apps/analytics/apps.py` - App config
- `apps/analytics/models.py` - MenuView and DailyMenuStats models
- `apps/analytics/services.py` - track_menu_view, get_analytics_summary, aggregate_daily_stats
- `apps/analytics/serializers.py` - TrackMenuViewSerializer, AnalyticsSummarySerializer
- `apps/analytics/views.py` - TrackMenuViewAPI (public), AnalyticsSummaryAPI (authenticated)
- `apps/analytics/urls.py` - URL routing for analytics endpoints
- `apps/analytics/migrations/0001_initial.py` - Initial migration
- `apps/analytics/tests/test_analytics.py` - 14 comprehensive tests
- `config/settings/base.py` - Added apps.analytics to INSTALLED_APPS
- `config/settings/testing.py` - Added apps.analytics to SKIP_GIS_APPS block
- `config/urls.py` - Added analytics URL routing

**Frontend (apps/web):**
- `lib/hooks/useAnalytics.ts` - Analytics hook with tracking functions
- `app/[locale]/menu/[slug]/page.tsx` - Added tracking on page load
- `app/[locale]/lite/dashboard/page.tsx` - Integrated real analytics data
- `app/[locale]/lite/upgrade/page.tsx` - Upgrade page with tier comparison
- `messages/en.json` - English translations for upgrade page
- `messages/fr.json` - French translations for upgrade page

## Decisions Made

1. **JSONField over ArrayField** - Used JSONField for top_items to ensure SQLite compatibility during testing. PostgreSQL supports both, but SQLite only supports JSONField.

2. **localStorage for session tracking** - Session ID stored in localStorage (not sessionStorage) to persist across browser sessions and accurately track returning visitors.

3. **Source detection strategy** - Check URL params first (?source=qr), then check referrer for WhatsApp. Default to "link" for direct access.

4. **Pro tier as "Coming Soon"** - Upgrade button shows "Coming Soon" instead of functional upgrade. Email capture form collects interest for future payment integration.

5. **useRef for tracking guard** - Used useRef to prevent duplicate tracking calls on component re-renders in React strict mode.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking] Changed ArrayField to JSONField**
- **Found during:** Task 3 (Running tests)
- **Issue:** PostgreSQL ArrayField not compatible with SQLite test database
- **Fix:** Changed top_items field from ArrayField to JSONField
- **Files modified:** apps/analytics/models.py, apps/analytics/migrations/0001_initial.py
- **Verification:** All 14 tests pass
- **Committed in:** 5123e13 (Task 3 commit)

---

**Total deviations:** 1 auto-fixed (blocking issue)
**Impact on plan:** Necessary for test compatibility. No functional change - JSONField works identically for this use case.

## Issues Encountered

- GDAL not installed on Windows dev machine - used SKIP_GIS_APPS=1 for testing
- WeasyPrint warnings during tests (expected, not blocking)

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness

**What's ready:**
- Analytics tracking infrastructure complete
- Dashboard displays real view counts
- Upgrade page ready for future payment integration
- All Phase 5.5 (RESTO360 Lite) work complete

**Blockers/concerns:**
- Pro tier payment processing not implemented (Coming Soon placeholder)
- Email interest capture logs to console only (no backend storage yet)

---
*Phase: 05.5-resto360-lite*
*Completed: 2026-02-04*
