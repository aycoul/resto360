---
phase: 02-pos-core
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - apps/api/requirements/base.txt
  - apps/api/apps/menu/__init__.py
  - apps/api/apps/menu/models.py
  - apps/api/apps/menu/serializers.py
  - apps/api/apps/menu/views.py
  - apps/api/apps/menu/urls.py
  - apps/api/apps/menu/admin.py
  - apps/api/apps/menu/tests/test_models.py
  - apps/api/apps/menu/tests/test_api.py
  - apps/api/config/settings/base.py
  - apps/api/config/urls.py
autonomous: true

must_haves:
  truths:
    - "Manager can create menu categories with name and display order"
    - "Manager can create menu items with name, price, description, and image"
    - "Manager can create modifiers with options and price adjustments"
    - "Menu items are scoped to restaurant (multi-tenant)"
    - "API returns nested menu structure (categories -> items -> modifiers)"
  artifacts:
    - path: "apps/api/apps/menu/models.py"
      provides: "Category, MenuItem, Modifier, ModifierOption models"
      contains: "class Category"
    - path: "apps/api/apps/menu/serializers.py"
      provides: "Nested serializers for full menu"
      contains: "class MenuItemSerializer"
    - path: "apps/api/apps/menu/views.py"
      provides: "ViewSets with permission classes"
      contains: "class CategoryViewSet"
    - path: "apps/api/apps/menu/urls.py"
      provides: "URL routing for /api/v1/menu/"
      contains: "router.register"
  key_links:
    - from: "apps/api/apps/menu/models.py"
      to: "apps/api/apps/core/models.py"
      via: "TenantModel inheritance"
      pattern: "class.*TenantModel"
    - from: "apps/api/apps/menu/views.py"
      to: "apps/api/apps/core/permissions.py"
      via: "Permission classes"
      pattern: "IsOwnerOrManager"
---

<objective>
Create the menu management backend with Category, MenuItem, Modifier, and ModifierOption models.

Purpose: Provide the data layer for menu management - categories organize items, items have modifiers for customization (size, extras). This is foundational for POS ordering and kitchen display.

Output: Working API endpoints at /api/v1/menu/ for full menu CRUD with nested serializers.
</objective>

<execution_context>
@C:\Users\dell\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dell\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-pos-core/02-RESEARCH.md

# Phase 1 established patterns
@apps/api/apps/core/models.py
@apps/api/apps/core/managers.py
@apps/api/apps/core/permissions.py
@apps/api/apps/authentication/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create menu app structure</name>
  <files>
    apps/api/requirements/base.txt
    apps/api/apps/menu/__init__.py
    apps/api/apps/menu/apps.py
  </files>
  <action>
    1. Add to requirements/base.txt:
       - django-imagekit>=6.0
       - Pillow>=10.0
       - drf-writable-nested>=0.7.0

    2. Create menu app at apps/api/apps/menu/:
       - __init__.py (empty)
       - apps.py with MenuConfig (name='apps.menu')

    3. Install requirements: pip install -r requirements/base.txt

    4. Add 'apps.menu' to INSTALLED_APPS in config/settings/base.py

    5. Add 'imagekit' to INSTALLED_APPS in config/settings/base.py
  </action>
  <verify>python apps/api/manage.py check --settings=config.settings.development</verify>
  <done>Menu app registered, imagekit installed, Django check passes</done>
</task>

<task type="auto">
  <name>Task 2: Create menu models with tenant isolation</name>
  <files>
    apps/api/apps/menu/models.py
    apps/api/apps/menu/admin.py
  </files>
  <action>
    Create models in apps/api/apps/menu/models.py:

    1. Category(TenantModel):
       - name: CharField(max_length=100)
       - display_order: PositiveIntegerField(default=0)
       - is_visible: BooleanField(default=True)
       - Meta: ordering = ['display_order', 'name']
       - __str__: return self.name

    2. MenuItem(TenantModel):
       - category: ForeignKey(Category, related_name='items', on_delete=CASCADE)
       - name: CharField(max_length=200)
       - description: TextField(blank=True)
       - price: PositiveIntegerField() (XOF - no decimals)
       - image: ImageField(upload_to='menu_items/', blank=True, null=True)
       - thumbnail: ImageSpecField via imagekit (source='image', processors=[ResizeToFill(300,300)], format='JPEG', options={'quality': 85})
       - is_available: BooleanField(default=True)
       - Meta: ordering = ['name']
       - __str__: return self.name

    3. Modifier(TenantModel):
       - menu_item: ForeignKey(MenuItem, related_name='modifiers', on_delete=CASCADE)
       - name: CharField(max_length=100) (e.g., "Size", "Extras")
       - required: BooleanField(default=False)
       - max_selections: PositiveIntegerField(default=1) (0=unlimited)
       - display_order: PositiveIntegerField(default=0)
       - Meta: ordering = ['display_order', 'name']
       - __str__: return f"{self.menu_item.name} - {self.name}"

    4. ModifierOption(TenantModel):
       - modifier: ForeignKey(Modifier, related_name='options', on_delete=CASCADE)
       - name: CharField(max_length=100) (e.g., "Small", "Large")
       - price_adjustment: IntegerField(default=0) (can be negative for discounts)
       - is_available: BooleanField(default=True)
       - display_order: PositiveIntegerField(default=0)
       - Meta: ordering = ['display_order', 'name']
       - __str__: return f"{self.modifier.name} - {self.name}"

    Create admin.py with:
    - CategoryAdmin with list_display, list_filter by restaurant
    - MenuItemAdmin with list_display, search_fields, list_filter by category, restaurant
    - ModifierAdmin and ModifierOptionAdmin with inline editing

    Run: python apps/api/manage.py makemigrations menu
    Run: python apps/api/manage.py migrate
  </action>
  <verify>python apps/api/manage.py showmigrations menu (should show applied migration)</verify>
  <done>All 4 models created with TenantModel inheritance, migrations applied</done>
</task>

<task type="auto">
  <name>Task 3: Create serializers and API endpoints</name>
  <files>
    apps/api/apps/menu/serializers.py
    apps/api/apps/menu/views.py
    apps/api/apps/menu/urls.py
    apps/api/config/urls.py
  </files>
  <action>
    Create serializers.py with nested serializers:

    1. ModifierOptionSerializer:
       - fields: id, name, price_adjustment, is_available, display_order

    2. ModifierSerializer:
       - options = ModifierOptionSerializer(many=True, read_only=True)
       - fields: id, name, required, max_selections, display_order, options

    3. MenuItemSerializer:
       - modifiers = ModifierSerializer(many=True, read_only=True)
       - thumbnail_url = SerializerMethodField()
       - fields: id, category, name, description, price, image, thumbnail_url, is_available, modifiers
       - get_thumbnail_url: return obj.thumbnail.url if obj.thumbnail else None

    4. CategorySerializer:
       - items = MenuItemSerializer(many=True, read_only=True)
       - fields: id, name, display_order, is_visible, items

    5. MenuItemWriteSerializer (for create/update):
       - fields: id, category, name, description, price, image, is_available
       - validate_price: ensure >= 0

    6. FullMenuSerializer (for GET /api/v1/menu/full/):
       - categories = CategorySerializer(many=True)
       - Return full nested menu for POS/customer display

    Create views.py with ViewSets:

    1. CategoryViewSet(ModelViewSet):
       - queryset: Category.objects.all() (TenantManager filters automatically)
       - serializer_class: CategorySerializer
       - permission_classes: [IsAuthenticated, IsOwnerOrManager]
       - filter by is_visible for non-manager users

    2. MenuItemViewSet(ModelViewSet):
       - get_serializer_class: MenuItemSerializer for read, MenuItemWriteSerializer for write
       - permission_classes: [IsAuthenticated, IsOwnerOrManager]
       - filter_backends: support filtering by category_id

    3. ModifierViewSet(ModelViewSet):
       - permission_classes: [IsAuthenticated, IsOwnerOrManager]
       - filter by menu_item_id

    4. ModifierOptionViewSet(ModelViewSet):
       - permission_classes: [IsAuthenticated, IsOwnerOrManager]
       - filter by modifier_id

    5. FullMenuView(APIView):
       - GET: Return all categories with nested items/modifiers
       - permission_classes: [IsAuthenticated] (any authenticated user)
       - Optimize with select_related and prefetch_related

    Create urls.py with router:
    - router.register('categories', CategoryViewSet)
    - router.register('items', MenuItemViewSet)
    - router.register('modifiers', ModifierViewSet)
    - router.register('modifier-options', ModifierOptionViewSet)
    - path('full/', FullMenuView.as_view())

    Include in config/urls.py:
    - path('api/v1/menu/', include('apps.menu.urls'))
  </action>
  <verify>curl -X GET http://localhost:8000/api/v1/menu/full/ -H "Authorization: Bearer TOKEN" (with valid JWT)</verify>
  <done>All ViewSets created, URLs registered, nested menu endpoint working</done>
</task>

<task type="auto">
  <name>Task 4: Create comprehensive tests</name>
  <files>
    apps/api/apps/menu/tests/__init__.py
    apps/api/apps/menu/tests/factories.py
    apps/api/apps/menu/tests/conftest.py
    apps/api/apps/menu/tests/test_models.py
    apps/api/apps/menu/tests/test_api.py
  </files>
  <action>
    Create tests/ directory with:

    1. factories.py (Factory Boy):
       - CategoryFactory(restaurant from fixture)
       - MenuItemFactory(category from fixture)
       - ModifierFactory(menu_item from fixture)
       - ModifierOptionFactory(modifier from fixture)

    2. conftest.py:
       - Fixtures for restaurant, owner_user, manager_user, cashier_user
       - Authenticated client fixtures
       - Sample menu data fixtures

    3. test_models.py:
       - Test Category creation with restaurant
       - Test MenuItem with category relationship
       - Test Modifier with menu_item relationship
       - Test ModifierOption with price_adjustment
       - Test TenantManager filtering (user from restaurant A can't see restaurant B items)
       - Test cascade delete (category delete cascades to items)

    4. test_api.py:
       - Test category CRUD (owner can create, read, update, delete)
       - Test menu item CRUD with image upload
       - Test modifier and option CRUD
       - Test full menu endpoint returns nested structure
       - Test permission: cashier cannot create categories
       - Test multi-tenant isolation: user A cannot see user B's menu
       - Test filtering: items by category_id

    Run: pytest apps/api/apps/menu/tests/ -v
  </action>
  <verify>pytest apps/api/apps/menu/tests/ -v --tb=short (all tests pass)</verify>
  <done>All tests pass, model and API coverage complete</done>
</task>

</tasks>

<verification>
1. Django check passes: python apps/api/manage.py check
2. All migrations applied: python apps/api/manage.py showmigrations
3. All tests pass: pytest apps/api/apps/menu/ -v
4. Lint passes: ruff check apps/api/apps/menu/
5. Full menu endpoint returns nested JSON structure
</verification>

<success_criteria>
- Category, MenuItem, Modifier, ModifierOption models exist with TenantModel
- API endpoints at /api/v1/menu/ for all CRUD operations
- Nested serializers return full menu in single request
- Multi-tenant isolation verified by tests
- Permission classes restrict mutations to owner/manager
- All tests pass (minimum 20 tests)
</success_criteria>

<output>
After completion, create `.planning/phases/02-pos-core/02-01-SUMMARY.md`
</output>
