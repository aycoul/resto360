---
phase: 02-pos-core
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - apps/api/requirements/base.txt
  - apps/api/apps/orders/__init__.py
  - apps/api/apps/orders/models.py
  - apps/api/apps/orders/serializers.py
  - apps/api/apps/orders/views.py
  - apps/api/apps/orders/urls.py
  - apps/api/apps/orders/services.py
  - apps/api/apps/orders/admin.py
  - apps/api/apps/receipts/services.py
  - apps/api/apps/receipts/templates/receipts/receipt.html
  - apps/api/apps/qr/services.py
  - apps/api/config/settings/base.py
  - apps/api/config/urls.py
autonomous: true

must_haves:
  truths:
    - "Cashier can create order with items, modifiers, and order type"
    - "Order gets unique daily number (resets each day per restaurant)"
    - "Order has status: pending, preparing, ready, completed, cancelled"
    - "Table can be assigned for dine-in orders"
    - "PDF receipt can be generated for any order"
    - "QR code generates URL to restaurant menu"
  artifacts:
    - path: "apps/api/apps/orders/models.py"
      provides: "Order, OrderItem, OrderItemModifier, Table, DailySequence models"
      contains: "class Order"
    - path: "apps/api/apps/orders/services.py"
      provides: "Daily order number generation"
      contains: "get_next_order_number"
    - path: "apps/api/apps/receipts/services.py"
      provides: "PDF receipt generation"
      contains: "generate_receipt_pdf"
    - path: "apps/api/apps/qr/services.py"
      provides: "QR code generation"
      contains: "generate_menu_qr"
  key_links:
    - from: "apps/api/apps/orders/models.py"
      to: "apps/api/apps/menu/models.py"
      via: "MenuItem foreign key"
      pattern: "ForeignKey.*MenuItem"
    - from: "apps/api/apps/orders/views.py"
      to: "apps/api/apps/orders/services.py"
      via: "Order number generation on create"
      pattern: "get_next_order_number"
---

<objective>
Create the order management backend with Order, OrderItem, Table models, plus receipt PDF and QR code generation.

Purpose: Enable cashiers to submit orders with items and modifiers, track order lifecycle, and generate receipts. This is the core transaction system for the POS.

Output: Working API endpoints at /api/v1/orders/ for order CRUD, receipt PDF download, and QR code generation.
</objective>

<execution_context>
@C:\Users\dell\.claude/get-shit-done/workflows/execute-plan.md
@C:\Users\dell\.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-pos-core/02-RESEARCH.md

# Depends on Plan 01
@.planning/phases/02-pos-core/02-01-SUMMARY.md

# Core infrastructure
@apps/api/apps/core/models.py
@apps/api/apps/core/permissions.py
@apps/api/apps/menu/models.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install dependencies and create orders/receipts/qr apps</name>
  <files>
    apps/api/requirements/base.txt
    apps/api/apps/orders/__init__.py
    apps/api/apps/orders/apps.py
    apps/api/apps/receipts/__init__.py
    apps/api/apps/receipts/apps.py
    apps/api/apps/qr/__init__.py
    apps/api/apps/qr/apps.py
    apps/api/config/settings/base.py
  </files>
  <action>
    1. Add to requirements/base.txt:
       - weasyprint>=68.0
       - segno>=1.6.6

    2. Create three apps:
       - apps/api/apps/orders/ with OrdersConfig (name='apps.orders')
       - apps/api/apps/receipts/ with ReceiptsConfig (name='apps.receipts')
       - apps/api/apps/qr/ with QRConfig (name='apps.qr')

    3. Install requirements: pip install -r requirements/base.txt

    4. Add to INSTALLED_APPS in config/settings/base.py:
       - 'apps.orders'
       - 'apps.receipts'
       - 'apps.qr'

    5. Add MEDIA settings to base.py if not present:
       - MEDIA_URL = '/media/'
       - MEDIA_ROOT = BASE_DIR / 'media'

    6. Add FRONTEND_URL to base.py:
       - FRONTEND_URL = env('FRONTEND_URL', default='http://localhost:3000')
  </action>
  <verify>python apps/api/manage.py check --settings=config.settings.development</verify>
  <done>All three apps registered, weasyprint and segno installed</done>
</task>

<task type="auto">
  <name>Task 2: Create order models with daily sequence</name>
  <files>
    apps/api/apps/orders/models.py
    apps/api/apps/orders/services.py
    apps/api/apps/orders/admin.py
  </files>
  <action>
    Create models in apps/api/apps/orders/models.py:

    1. Table(TenantModel):
       - number: CharField(max_length=20) (e.g., "T1", "Patio 3")
       - capacity: PositiveIntegerField(default=4)
       - is_active: BooleanField(default=True)
       - Meta: unique_together = ['restaurant', 'number']
       - __str__: return f"Table {self.number}"

    2. DailySequence(models.Model) - NOT TenantModel, uses explicit FK:
       - restaurant: ForeignKey(Restaurant, on_delete=CASCADE)
       - day: DateField()
       - sequence: PositiveIntegerField(default=0)
       - Meta: unique_together = ['restaurant', 'day']
       - Meta: indexes = [Index(fields=['restaurant', 'day'])]

    3. OrderType enum:
       - DINE_IN = 'dine_in'
       - TAKEOUT = 'takeout'
       - DELIVERY = 'delivery'

    4. OrderStatus enum:
       - PENDING = 'pending'
       - PREPARING = 'preparing'
       - READY = 'ready'
       - COMPLETED = 'completed'
       - CANCELLED = 'cancelled'

    5. Order(TenantModel):
       - order_number: PositiveIntegerField() (daily sequence number)
       - order_type: CharField(max_length=20, choices=OrderType)
       - status: CharField(max_length=20, choices=OrderStatus, default=PENDING)
       - table: ForeignKey(Table, null=True, blank=True, on_delete=SET_NULL)
       - customer_name: CharField(max_length=100, blank=True)
       - customer_phone: CharField(max_length=20, blank=True)
       - notes: TextField(blank=True)
       - subtotal: PositiveIntegerField(default=0)
       - total: PositiveIntegerField(default=0)
       - created_by: ForeignKey(User, on_delete=SET_NULL, null=True)
       - Meta: ordering = ['-created_at']
       - Meta: indexes for restaurant+status, restaurant+created_at
       - __str__: return f"Order #{self.order_number}"

    6. OrderItem(TenantModel):
       - order: ForeignKey(Order, related_name='items', on_delete=CASCADE)
       - menu_item: ForeignKey(MenuItem, on_delete=PROTECT)
       - quantity: PositiveIntegerField(default=1)
       - unit_price: PositiveIntegerField() (captured at order time)
       - notes: CharField(max_length=200, blank=True)
       - Meta: ordering = ['id']

    7. OrderItemModifier(TenantModel):
       - order_item: ForeignKey(OrderItem, related_name='modifiers', on_delete=CASCADE)
       - modifier_option: ForeignKey(ModifierOption, on_delete=PROTECT)
       - price_adjustment: IntegerField() (captured at order time)

    Create services.py with DailySequenceManager:
       - get_next_order_number(restaurant): atomic SELECT FOR UPDATE, increment, return sequence

    Create admin.py with:
       - OrderAdmin with list_display, list_filter by status, restaurant
       - OrderItemInline for viewing items
       - TableAdmin with list_display

    Run: python apps/api/manage.py makemigrations orders
    Run: python apps/api/manage.py migrate
  </action>
  <verify>python apps/api/manage.py showmigrations orders (should show applied migration)</verify>
  <done>All order models created, daily sequence service working, migrations applied</done>
</task>

<task type="auto">
  <name>Task 3: Create order serializers and API endpoints</name>
  <files>
    apps/api/apps/orders/serializers.py
    apps/api/apps/orders/views.py
    apps/api/apps/orders/urls.py
    apps/api/config/urls.py
  </files>
  <action>
    Create serializers.py:

    1. OrderItemModifierSerializer:
       - fields: id, modifier_option, modifier_option_name (read_only), price_adjustment

    2. OrderItemSerializer:
       - modifiers = OrderItemModifierSerializer(many=True, read_only=True)
       - menu_item_name = SerializerMethodField()
       - fields: id, menu_item, menu_item_name, quantity, unit_price, notes, modifiers

    3. OrderSerializer:
       - items = OrderItemSerializer(many=True, read_only=True)
       - fields: id, order_number, order_type, status, table, customer_name, customer_phone, notes, subtotal, total, items, created_at, created_by

    4. OrderCreateSerializer:
       - items = nested list of {menu_item_id, quantity, notes, modifiers: [{modifier_option_id}]}
       - Validate: order_type required, table required for dine_in
       - create(): Atomic transaction:
         a. Get next order number via service
         b. Create Order
         c. Create OrderItems with captured prices
         d. Create OrderItemModifiers with captured price adjustments
         e. Calculate subtotal and total
         f. Return created order

    5. OrderStatusUpdateSerializer:
       - status = ChoiceField(choices=OrderStatus.choices)
       - Validate: only allow valid transitions (pending->preparing->ready->completed, any->cancelled)

    6. TableSerializer:
       - fields: id, number, capacity, is_active

    Create views.py:

    1. OrderViewSet(ModelViewSet):
       - get_serializer_class: OrderSerializer for read, OrderCreateSerializer for create
       - permission_classes: [IsAuthenticated, IsCashierOrAbove]
       - filter by status, order_type, date range
       - perform_create: set created_by from request.user

    2. OrderStatusUpdateView(APIView):
       - PATCH /api/v1/orders/{id}/status/
       - permission_classes: [IsAuthenticated] (kitchen can update)
       - Update status, trigger WebSocket notification (stub for now)

    3. KitchenQueueView(ListAPIView):
       - GET /api/v1/orders/queue/
       - Return orders with status in [pending, preparing, ready]
       - permission_classes: [IsAuthenticated]
       - Order by created_at

    4. TableViewSet(ModelViewSet):
       - permission_classes: [IsAuthenticated, IsOwnerOrManager]

    Create urls.py with router:
    - router.register('orders', OrderViewSet, basename='order')
    - router.register('tables', TableViewSet, basename='table')
    - path('orders/<uuid:pk>/status/', OrderStatusUpdateView.as_view())
    - path('orders/queue/', KitchenQueueView.as_view())

    Include in config/urls.py:
    - path('api/v1/', include('apps.orders.urls'))
  </action>
  <verify>Create order via API and verify order_number is assigned</verify>
  <done>Order CRUD working, status updates working, kitchen queue endpoint working</done>
</task>

<task type="auto">
  <name>Task 4: Create receipt PDF and QR code services</name>
  <files>
    apps/api/apps/receipts/services.py
    apps/api/apps/receipts/views.py
    apps/api/apps/receipts/urls.py
    apps/api/apps/receipts/templates/receipts/receipt.html
    apps/api/apps/qr/services.py
    apps/api/apps/qr/views.py
    apps/api/apps/qr/urls.py
    apps/api/config/urls.py
  </files>
  <action>
    Create receipts/services.py:
    ```python
    def generate_receipt_pdf(order) -> bytes:
        """Generate PDF receipt from order using WeasyPrint"""
        html_string = render_to_string('receipts/receipt.html', {
            'order': order,
            'restaurant': order.restaurant,
            'items': order.items.select_related('menu_item').prefetch_related('modifiers__modifier_option'),
        })
        html = HTML(string=html_string)
        css = CSS(string='''
            @page { size: 80mm 200mm; margin: 5mm; }
            body { font-family: monospace; font-size: 10pt; }
            .header { text-align: center; margin-bottom: 10pt; }
            .items { width: 100%; }
            .total { border-top: 1px dashed black; margin-top: 10pt; padding-top: 5pt; }
        ''')
        buffer = BytesIO()
        html.write_pdf(buffer, stylesheets=[css])
        buffer.seek(0)
        return buffer.getvalue()
    ```

    Create receipts/templates/receipts/receipt.html:
    - Restaurant name and address header
    - Order number and date
    - Table (if dine-in)
    - Items with quantity, name, price
    - Modifiers indented under items
    - Subtotal and total
    - Footer with thank you message

    Create receipts/views.py:
    ```python
    class ReceiptPDFView(APIView):
        permission_classes = [IsAuthenticated]

        def get(self, request, order_id):
            order = get_object_or_404(Order, id=order_id, restaurant=request.user.restaurant)
            pdf = generate_receipt_pdf(order)
            return HttpResponse(pdf, content_type='application/pdf',
                headers={'Content-Disposition': f'inline; filename="receipt-{order.order_number}.pdf"'})
    ```

    Create receipts/urls.py:
    - path('<uuid:order_id>/pdf/', ReceiptPDFView.as_view())

    Create qr/services.py:
    ```python
    def generate_menu_qr(restaurant_slug: str) -> bytes:
        """Generate QR code PNG for restaurant menu URL"""
        menu_url = f"{settings.FRONTEND_URL}/menu/{restaurant_slug}"
        qr = segno.make(menu_url, error='H')
        buffer = BytesIO()
        qr.save(buffer, kind='png', scale=10, border=2)
        buffer.seek(0)
        return buffer.getvalue()
    ```

    Create qr/views.py:
    ```python
    class MenuQRView(APIView):
        permission_classes = [IsAuthenticated, IsOwnerOrManager]

        def get(self, request):
            restaurant = request.user.restaurant
            png = generate_menu_qr(restaurant.slug)
            return HttpResponse(png, content_type='image/png',
                headers={'Content-Disposition': f'inline; filename="menu-qr-{restaurant.slug}.png"'})
    ```

    Create qr/urls.py:
    - path('menu/', MenuQRView.as_view())

    Update config/urls.py:
    - path('api/v1/receipts/', include('apps.receipts.urls'))
    - path('api/v1/qr/', include('apps.qr.urls'))

    Add 'slug' field to Restaurant model if not present (migration in authentication app).
  </action>
  <verify>curl -X GET http://localhost:8000/api/v1/qr/menu/ returns PNG image</verify>
  <done>Receipt PDF generation working, QR code generation working</done>
</task>

<task type="auto">
  <name>Task 5: Create comprehensive tests</name>
  <files>
    apps/api/apps/orders/tests/__init__.py
    apps/api/apps/orders/tests/factories.py
    apps/api/apps/orders/tests/conftest.py
    apps/api/apps/orders/tests/test_models.py
    apps/api/apps/orders/tests/test_api.py
    apps/api/apps/orders/tests/test_services.py
  </files>
  <action>
    Create tests/ directory with:

    1. factories.py:
       - TableFactory
       - OrderFactory
       - OrderItemFactory
       - OrderItemModifierFactory

    2. conftest.py:
       - Fixtures for restaurant, users at different roles
       - Authenticated client fixtures
       - Sample order data

    3. test_models.py:
       - Test Order creation with order_number
       - Test OrderItem with menu_item relationship
       - Test OrderItemModifier with price capture
       - Test cascade delete behavior
       - Test DailySequence increment

    4. test_api.py:
       - Test order creation with items and modifiers
       - Test order_number is unique per day per restaurant
       - Test order status update
       - Test kitchen queue returns correct orders
       - Test permission: cashier can create orders
       - Test permission: kitchen can update status
       - Test table CRUD
       - Test receipt PDF download
       - Test QR code generation
       - Test multi-tenant isolation

    5. test_services.py:
       - Test get_next_order_number returns sequential numbers
       - Test sequence resets on new day
       - Test concurrent order creation (atomic safety)
       - Test generate_receipt_pdf returns valid PDF bytes
       - Test generate_menu_qr returns valid PNG bytes

    Run: pytest apps/api/apps/orders/tests/ apps/api/apps/receipts/ apps/api/apps/qr/ -v
  </action>
  <verify>pytest apps/api/apps/orders/ -v --tb=short (all tests pass)</verify>
  <done>All tests pass, comprehensive coverage for orders, receipts, QR</done>
</task>

</tasks>

<verification>
1. Django check passes: python apps/api/manage.py check
2. All migrations applied: python apps/api/manage.py showmigrations
3. All tests pass: pytest apps/api/apps/orders/ apps/api/apps/receipts/ apps/api/apps/qr/ -v
4. Lint passes: ruff check apps/api/apps/orders/ apps/api/apps/receipts/ apps/api/apps/qr/
5. Order creation returns unique daily order number
6. Receipt PDF downloads correctly
7. QR code returns PNG image
</verification>

<success_criteria>
- Order, OrderItem, OrderItemModifier, Table, DailySequence models exist
- Orders can be created with items and modifiers in single request
- Order numbers are unique per restaurant per day
- Order status can be updated through lifecycle
- Kitchen queue returns pending/preparing/ready orders
- Receipt PDF generates correctly formatted 80mm thermal receipt
- QR code generates PNG pointing to menu URL
- All tests pass (minimum 25 tests)
</success_criteria>

<output>
After completion, create `.planning/phases/02-pos-core/02-02-SUMMARY.md`
</output>
